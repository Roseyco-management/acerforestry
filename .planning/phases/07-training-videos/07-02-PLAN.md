---
phase: 07-training-videos
plan: 02
type: execute
---

<objective>
Integrate analytics tracking (Clarity, GA4, Meta Pixel) and optimize video page for performance

Purpose: Enable comprehensive user behavior insights with Clarity, Google Analytics 4, and Meta Pixel while ensuring training page maintains fast loading on rural connections.
Output: Three analytics platforms integrated site-wide with optimal loading strategy, training page optimized for performance with lazy loading and efficient resource management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-training-videos/07-01-SUMMARY.md
@src/app/layout.tsx
@src/app/training/page.tsx

**Tech stack available:**
- Next.js 15.1.4 with App Router
- TypeScript for type safety
- Script component from next/script for optimized script loading

**Analytics tracking requirements:**

1. **Microsoft Clarity (ID: vctdn13vdm)**
```javascript
(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "vctdn13vdm");
```

2. **Google Analytics 4 (ID: G-T8D6192HYW)**
- External script: https://www.googletagmanager.com/gtag/js?id=G-T8D6192HYW
- Init script: window.dataLayer setup and gtag config

3. **Meta Pixel (ID: 2129581217798932)**
- fbq initialization with PageView tracking
- Noscript fallback image for non-JS users

**Performance considerations for rural connectivity:**
- All analytics scripts use afterInteractive strategy (don't block page render)
- Minimize initial page load time impact
- Next.js Script component handles optimal loading order
- Multiple scripts coordinated to avoid performance degradation

**Established patterns:**
- Root layout (src/app/layout.tsx) contains site-wide elements
- Metadata configuration in layout for global settings
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate analytics tracking (Clarity, GA4, Meta Pixel)</name>
  <files>src/app/layout.tsx</files>
  <action>Add three analytics tracking scripts to root layout using Next.js Script component. Import Script from 'next/script'. Add all three scripts in body (after children) with strategy="afterInteractive" to avoid blocking page load:

1. **Google Analytics 4:** External script src="https://www.googletagmanager.com/gtag/js?id=G-T8D6192HYW" followed by inline script initializing window.dataLayer and calling gtag('js', new Date()) and gtag('config', 'G-T8D6192HYW')

2. **Microsoft Clarity:** Inline script with Clarity initialization: (function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script", "vctdn13vdm");

3. **Meta Pixel:** Inline script with fbq initialization, fbq('init', '2129581217798932') and fbq('track', 'PageView'). Add noscript fallback with 1x1 tracking pixel image after scripts.

All scripts use strategy="afterInteractive" ensuring they load after page is interactive, not blocking initial render. This site-wide integration tracks all pages.</action>
  <verify>npm run build succeeds, all three tracking scripts appear in page source, scripts load in browser DevTools Network tab (gtag/js, clarity.ms, fbevents.js), no TypeScript errors</verify>
  <done>All three analytics platforms integrated in root layout with afterInteractive strategy, builds successfully without errors, tracking active site-wide</done>
</task>

<task type="auto">
  <name>Task 2: Optimize training page video loading for performance</name>
  <files>src/app/training/page.tsx</files>
  <action>If videos are iframes (YouTube/Vimeo): ensure loading="lazy" attribute is present on all iframe elements. If videos are HTML5 video tags: add preload="none" to prevent auto-loading. Add intersection observer pattern or use native loading="lazy" to defer video loads until user scrolls to them. For YouTube embeds specifically, ensure iframe has allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" and allowFullScreen attributes for functionality. Verify aspect-video wrapper maintains 16:9 ratio on all screen sizes. If no videos yet (just placeholders), document the optimization pattern in code comments for when videos are added.</action>
  <verify>Videos (if present) load lazily, npm run build succeeds, DevTools Network shows videos don't load until viewport, page Lighthouse performance score acceptable</verify>
  <done>Video loading optimized with lazy load pattern, performance maintained for rural connections, no blocking resources on initial page load</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build succeeds without errors
- [ ] GA4 script loads in browser (check DevTools → Network → googletagmanager.com/gtag/js)
- [ ] Clarity script loads in browser (check DevTools → Network → clarity.ms)
- [ ] Meta Pixel loads in browser (check DevTools → Network → facebook.net/fbevents.js)
- [ ] All tracking scripts use afterInteractive strategy (don't block page render)
- [ ] Training page videos load lazily (if videos present) or pattern documented (if placeholders)
- [ ] No TypeScript errors
- [ ] Page performance acceptable on throttled connection despite three tracking scripts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- GA4, Clarity, and Meta Pixel tracking active across all site pages
- All three analytics platforms load with afterInteractive strategy
- Training page optimized for rural connection performance
- No errors or warnings introduced
- Phase 7 complete and ready for Phase 8 (Animations & Polish)
</success_criteria>

<output>
After completion, create `.planning/phases/07-training-videos/07-02-SUMMARY.md`:

# Phase 07 Plan 02: Analytics and Performance Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- Integrated three analytics platforms site-wide: Google Analytics 4, Microsoft Clarity, and Meta Pixel
- All tracking scripts load with afterInteractive strategy for optimal performance
- Optimized video loading with lazy load pattern
- Ensured performance on rural connections despite multiple tracking scripts
- Completed Phase 7 training videos infrastructure

## Files Created/Modified

- `src/app/layout.tsx` - Added GA4, Clarity, and Meta Pixel tracking scripts with afterInteractive strategy
- `src/app/training/page.tsx` - [Optimized video loading OR documented optimization pattern]

## Decisions Made

**Analytics strategy:** Used afterInteractive for all three tracking platforms (GA4, Clarity, Meta Pixel) to load after page is interactive, avoiding any blocking of initial render or core functionality. This ensures analytics don't impact perceived page load speed.

**Script order:** GA4 first (site-wide behavior), Clarity second (UX insights), Meta Pixel third (conversion tracking). All load asynchronously after interactive.

[Document video loading optimization approach - lazy loading, intersection observer, or pattern for future implementation]

## Issues Encountered

[Any issues or None]

## Next Phase Readiness

Phase 7 complete. Training videos page fully functional with:
- Comprehensive analytics tracking via GA4, Clarity, and Meta Pixel
- [Video embeds with lazy loading OR placeholder infrastructure ready]
- Performance optimized for rural Scotland connections despite three tracking scripts
- Consistent design patterns from established component library

Ready for Phase 8 (Animations & Polish).
</output>
